class Random{static generate(e,t){return Math.floor(Math.random()*(t-e+1))+e}}class Entity{constructor(e,t,s){this.id=crypto.randomUUID(),this.row=e,this.col=t,this.canvas=s,this.type="",this.life=void 0,this.damage=0,this.maxMovement=null}async paint(){var e=await this.getCell(),t=await this.createDiv();e.element.appendChild(t)}destroy(){this.canvas.destroy(this.type,this.id)}getCell(){var e=this.canvas.getCellIdx(this.row,this.col);return this.canvas.rows[e.rowIdx].cells[e.cellIdx]}createDiv(){var e=document.createElement("div");return e.classList.add(this.type),void 0!==this.life&&(e.textContent=this.life),e}async move(e,t=void 0){if(null!==this.maxMovement){if(0===this.maxMovement)return!1;--this.maxMovement}var s=await this.nextRowCol(e);return void 0!==s&&(void 0===await this.getCellIdx(e,s)?(void 0!==t&&t(),!1):void this.updateColRow(e,s))}getCellIdx(e,t){return["left","right"].includes(e)?this.canvas.getCellIdx(this.row,t):["top","bottom"].includes(e)?this.canvas.getCellIdx(t,this.col):void 0}getCurrentCell(e,t){return["left","right"].includes(e)?this.canvas.rows[t.rowIdx].cells[this.currentIdx(e,t)]:["top","bottom"].includes(e)?this.canvas.rows[this.currentIdx(e,t)].cells[t.cellIdx]:void 0}updateColRow(e,t){["left","right"].includes(e)?this.col=t:["top","bottom"].includes(e)&&(this.row=t)}nextRowCol(e){switch(e){case"right":return this.col+1;case"left":return this.col-1;case"top":return this.row-1;case"bottom":return this.row+1;default:return}}currentIdx(e,t){switch(e){case"right":return t.cellIdx-1;case"left":return t.cellIdx+1;case"top":return t.rowIdx+1;case"bottom":return t.rowIdx-1;default:return t.cellIdx}}async reduceLife(e){if(void 0===this.life)return!1;var t;this.life-=this.life>e?e:this.life,0<this.life&&(e=await this.getCell(),t=await this.createDiv(),e.element.appendChild(t))}reduceDamage(e){if(this.damage<=0)return!1;this.damage-=this.damage>e?e:this.damage}}class Enemy extends Entity{constructor(e,t,s){super(e,t,s),this.type=PixelWar.ENTITY.ENEMY;e=this.calcLife();this.life=Random.generate(e.min,e.max)}calcLife(){switch(this.canvas.difficult){case PixelWar.DIFFICULT.EASY:return{min:1,max:2};case PixelWar.DIFFICULT.NORMAL:return{min:1,max:3};case PixelWar.DIFFICULT.HARD:return{min:1,max:4};default:return{min:1,max:2}}}}class Shot extends Entity{static speed=.01672*60;constructor(e,t,s){super(e,t,s),this.type=PixelWar.ENTITY.SHOT,this.damage=1}}class SuperShot extends Shot{static speed=.015*60;constructor(e,t,s){super(e,t,s),this.type=PixelWar.ENTITY.SUPER_SHOT,this.damage=this.calcDamage()}calcDamage(){switch(this.canvas.difficult){case PixelWar.DIFFICULT.EASY:return 8;case PixelWar.DIFFICULT.NORMAL:return 4;case PixelWar.DIFFICULT.HARD:return 2;default:return 8}}}class PortalShot extends Shot{static speed=.015*60;constructor(e,t,s){super(e,t,s),this.type=PixelWar.ENTITY.PORTAL_SHOT,this.damage=this.calcDamage(),this.maxMovement=Math.round(s.nbrRows/2)}calcDamage(){switch(this.canvas.difficult){case PixelWar.DIFFICULT.EASY:return 60;case PixelWar.DIFFICULT.NORMAL:return 40;case PixelWar.DIFFICULT.HARD:return 20;default:return 60}}}class Starship extends Entity{constructor(e,t,s){super(e,t,s),this.type=PixelWar.ENTITY.STARSHIP}shot(){var e=new Shot(this.row-1,this.col,this.canvas);this.canvas.shots.push(e)}superShot(){var e=this.canvas.energySuperShot;if(e.energy<e.cost)return!1;e.energy-=e.cost;e=new SuperShot(this.row-1,this.col,this.canvas);this.canvas.shots.push(e)}portalShot(){var e=this.canvas.energyPortalShot;if(e.energy<e.cost)return!1;e.energy-=e.cost;e=new PortalShot(this.row-1,this.col,this.canvas);this.canvas.shots.push(e)}}class Canvas{static ENEMY_CREATION_TIME_VALUE=60;static LOW_TIMING_EFFECT_VALUE=5;static CLASS_LIST={GAME_OVER:"game-over",PAUSE:"pause",SLOW_TIME:"slowTime",INFO:"info",INFO_ENERGY:"info-energy",TEXT_INFO:"text-info",VALUE_INFO:"value-info",CELL:"cell"};constructor(e,t,s,a){this.document=document.querySelector("body"),this.canvas=document.getElementById(e),this._nbrColumns=t,this._nbrRows=s,this._difficult=a,this.pause=!1,this.fShot=!0,this.setEvents()}set gameOver(e){this._gameOver=e}get gameOver(){return this._gameOver}set nbrColumns(e){this._nbrColumns=e}get nbrColumns(){return this._nbrColumns}set nbrRows(e){this._nbrRows=e}get nbrRows(){return this._nbrRows}set difficult(e){this._difficult=e}get difficult(){return this._difficult}init(){this.canvas.classList.remove(Canvas.CLASS_LIST.GAME_OVER),this.canvas.innerHTML="",this.info={},this.rows=[],this.enemies=[],this.shots=[],this.starship=new Starship(this.nbrRows,Math.round(this._nbrColumns/2),this),this.enemyCreationTime=Canvas.ENEMY_CREATION_TIME_VALUE,this.enemiesToSpawn=5,this._gameOver=!1,this.lifes=5,this.energySuperShot=this.createEnergyObj(1e3,5,1),this.energyPortalShot=this.createEnergyObj(500,10,2),this.energyTimeControl=this.createEnergyObj(250,20,4),this.speedShot=Shot.speed,this.speedSuperShot=SuperShot.speed,this.speedPortalShot=PortalShot.speed,this.lowTimingEffect=0,this.timeMultiplier=3}startNewGame(){this.init(),this.generate(),window.requestAnimationFrame(this.animate.bind(this))}pauseGame(){this.pause=!0,this.canvas.classList.add(Canvas.CLASS_LIST.PAUSE)}startGame(){this.pause=!1,this.canvas.classList.remove(Canvas.CLASS_LIST.PAUSE)}createEnergyObj(e,t,s){return{energy:e,cost:t,chargeTime:s*=60,stateChargeTime:s}}selfShotMovement(t,s){return new Promise(e=>{this.shots.forEach(e=>{if(e.type!==s)return!1;e.move(t,()=>e.destroy())}),e()})}setEvents(){this.document.addEventListener("keypress",this.moveStarship.bind(this)),this.document.addEventListener("keyup",this.enableShot.bind(this))}moveStarship(e){if(this.pause)return!1;if("KeyA"==e.code)this.starship.move("left");else if("KeyD"==e.code)this.starship.move("right");else if("KeyJ"==e.code){if(!this.fShot)return!1;this.fShot=!1,this.starship.shot(this)}else if("KeyK"==e.code){if(!this.fShot)return!1;this.fShot=!1,this.starship.superShot(this)}else if("KeyH"==e.code){if(!this.fShot)return!1;this.fShot=!1,this.starship.portalShot(this)}else if("KeyN"==e.code){e=this.energyTimeControl;if(e.energy<e.cost)return!1;e.energy-=e.cost,this.lowTimingEffect+=Canvas.LOW_TIMING_EFFECT_VALUE}}enableShot(e){if(this.pause)return!1;"KeyJ"!=e.code&&"KeyK"!=e.code&&"KeyH"!=e.code&&"KeyN"!=e.code||(this.fShot=!0)}async animate(){if(this._gameOver)return this.canvas.classList.add(Canvas.CLASS_LIST.GAME_OVER),!1;this.pause||(await this.updateEnergyValues(),await this.moveShots(),await this.destroyEntities(),--this.enemyCreationTime<=0&&(await this.spawnEnemies(),0<this.lowTimingEffect?(this.canvas.classList.add(Canvas.CLASS_LIST.SLOW_TIME),this.enemyCreationTime=Canvas.ENEMY_CREATION_TIME_VALUE*this.timeMultiplier,--this.lowTimingEffect):(this.canvas.classList.remove(Canvas.CLASS_LIST.SLOW_TIME),this.enemyCreationTime=Canvas.ENEMY_CREATION_TIME_VALUE)),await this.destroyEntities(),await this.clearCanvas(),await this.paintEnemies(),await this.paintShots(),this.updateInfoEnergy(),this.starship.paint(this)),window.requestAnimationFrame(this.animate.bind(this))}updateEnergyValues(){--this.energySuperShot.stateChargeTime<=0&&(this.energySuperShot.stateChargeTime=this.energySuperShot.chargeTime,this.energySuperShot.energy+=1),--this.energyPortalShot.stateChargeTime<=0&&(this.energyPortalShot.stateChargeTime=this.energyPortalShot.chargeTime,this.energyPortalShot.energy+=1),--this.energyTimeControl.stateChargeTime<=0&&(this.energyTimeControl.stateChargeTime=this.energyTimeControl.chargeTime,this.energyTimeControl.energy+=1)}async moveShots(){--this.speedShot<=0&&(await this.selfShotMovement("top",PixelWar.ENTITY.SHOT),this.speedShot=Shot.speed),--this.speedSuperShot<=0&&(await this.selfShotMovement("top",PixelWar.ENTITY.SUPER_SHOT),this.speedSuperShot=SuperShot.speed),--this.speedPortalShot<=0&&(await this.selfShotMovement("top",PixelWar.ENTITY.PORTAL_SHOT),this.speedPortalShot=PortalShot.speed)}updateInfoEnergy(){var{lifes:e,energySuperShot:{value:t},energyPortalShot:{value:s},energyTimeControl:{value:a}}=this.info;e.value.textContent=this.lifes,t.textContent=this.energySuperShot.energy,s.textContent=this.energyPortalShot.energy,a.textContent=this.energyTimeControl.energy}destroyEntities(){return new Promise(e=>{for(let e=this.enemies.length-1;0<=e;--e){var t,s=this.enemies[e];if(s.row===this.starship.row&&s.col===this.starship.col){this.lifes=0,this.gameOver=!0;break}for(t of this.shots)if(t.row===s.row&&t.col===s.col){var a=s.life;if(s.reduceLife(t.damage),t.reduceDamage(a),s.life<=0){s.destroy();break}t.damage<=0&&t.destroy()}}e()})}destroy(e,t){e=this.getPropertyNameForEntity(e);if(0===e.length)return!1;var s=this[e].findIndex(e=>e.id===t);this[e].splice(s,1)}getPropertyNameForEntity(e){return PixelWar.ENTITY.ENEMY===e?"enemies":PixelWar.ENTITY.SHOT===e||PixelWar.ENTITY.SUPER_SHOT===e||PixelWar.ENTITY.PORTAL_SHOT===e?"shots":""}paintShots(){this.shots.forEach(e=>e.paint(this))}paintEnemies(){this.enemies.forEach(e=>e.paint(this))}clearCanvas(){this.rows.forEach(e=>e.cells.forEach(e=>e.element.innerHTML=""))}generate(){this.createInfo(),this.createCells(),this.paintCells(),this.paintInfo()}createInfo(){var e=document.createElement("div"),t=(e.classList.add(Canvas.CLASS_LIST.INFO),this.createEnergyInfo("Lifes",this.lifes)),s=this.createEnergyInfo("Energy Super Shot",this.energySuperShot.energy),a=this.createEnergyInfo("Energy Portal Shot",this.energyPortalShot.energy),i=this.createEnergyInfo("Energy Time Control",this.energyTimeControl.energy);e.appendChild(t.el),e.appendChild(s.el),e.appendChild(a.el),e.appendChild(i.el),this.info={el:e,lifes:t,energySuperShot:s,energyPortalShot:a,energyTimeControl:i}}createEnergyInfo(e,t){var s=document.createElement("div"),a=(s.classList.add(Canvas.CLASS_LIST.INFO_ENERGY),document.createElement("span")),e=(a.classList.add(Canvas.CLASS_LIST.TEXT_INFO),a.textContent=e,document.createElement("span"));return e.classList.add(Canvas.CLASS_LIST.VALUE_INFO),e.textContent=t,s.appendChild(a),s.appendChild(e),{el:s,text:a,value:e}}paintInfo(){this.canvas.appendChild(this.info.el)}createCells(){for(let e=0;e<this.nbrRows;++e){var t=e+1;for(let e=0;e<this._nbrColumns;++e){var s=e+1,a=document.createElement("div");a.classList.add(Canvas.CLASS_LIST.CELL),a.dataset.row=t,a.dataset.col=s,this.pushCell({row:t,col:s,element:a})}}}pushCell(e){var t=this.getRowIdx(e.row);if(void 0===t)return this.rows.push({row:e.row,cells:[e]}),!1;this.rows[t].cells.push(e)}paintCells(){this.rows.forEach(e=>{e.cells.forEach(e=>{this.canvas.appendChild(e.element)})})}getRowIdx(s){let a=void 0;return this.rows.some((e,t)=>{if(e.row==s)return a=t,!0}),a}getCellIdx(e,s){e=this.getRowIdx(e);let a=void 0;if(void 0!==e&&(this.rows[e].cells.some((e,t)=>{if(e.col==s)return a=t,!0}),void 0!==a))return{rowIdx:e,cellIdx:a}}async spawnEnemies(){await this.moveEnemiesForward();var e=await this.createEnemies();await this.addEnemies(e)}async createEnemies(){const n=[];var e=await this.calcRangeEnemies();let o=Random.generate(e.min,e.max);return o>this._nbrColumns&&(o=this._nbrColumns),await new Promise(async a=>{var i=[];for(let s=1;s<=o;s++){let t=Random.generate(1,this._nbrColumns),e=10*this._nbrColumns;for(;i.some(e=>e==t)&&0<--e;)t=Random.generate(1,this._nbrColumns);i.push(t);var r=new Enemy(1,t,this);n.push(r),s===o&&a()}}),n}calcRangeEnemies(){switch(this._difficult){case PixelWar.DIFFICULT.EASY:return{min:3,max:6};case PixelWar.DIFFICULT.NORMAL:return{min:7,max:10};case PixelWar.DIFFICULT.HARD:return{min:11,max:14};default:return{min:3,max:6}}}addEnemies(e){e.forEach(e=>{this.enemies.push(e)})}moveEnemiesForward(){return new Promise(e=>{this.enemies.forEach(e=>e.move("bottom",()=>{e.destroy(),0<this.lifes&&--this.lifes<=0&&(this._gameOver=!0)})),e()})}}class PixelWar{static CANVAS_ID="canvas";static DIFFICULT={EASY:"easy",NORMAL:"normal",HARD:"hard"};static TOTAL_COLUMNS_DEFAULT_VALUE=11;static TOTAL_ROWS_DEFAULT_VALUE=20;static LIMIT_TOTAL_COLUMNS={min:5,max:50};static LIMIT_TOTAL_ROWS={min:10,max:30};static CELL_SIZE={width:1,height:1};static ENTITY={STARSHIP:"starship",SHOT:"shot",SUPER_SHOT:"super-shot",PORTAL_SHOT:"portal-shot",ENEMY:"enemy"};static CLASS_LIST={GAME_CONTAINER:"game-container",CANVAS:"canvas",CONTROLS:"controls",CBXS_CANVAS_SIZE:"cbxs-canvas-size",CBX_DIFFICULT_GAME:"cbx-difficult-game",BTN_START_GAME:"btn-start-game",PLAYING:"playing",BTN_PAUSE_GAME:"btn-pause-game",BTN_NEW_GAME:"btn-new-game",BTN_HELP_GAME:"btn-help-game",GAME_MODAL:"game-modal",GAME_MODAL_SIZE_MEDIUM:"game-modal-md",GAME_MODAL_CONTAINER:"game-modal-container",GAME_MODAL_HEADER:"game-modal-header",GAME_MODAL_BODY:"game-modal-body",GAME_MODAL_FOOTER:"game-modal-footer",GAME_MODAL_HIDDEN:"game-modal-hidden",GAME_MODAL_BTN_CLOSE:"game-modal-btn-close"};static TEXT_CONENT_LIST={PAUSE:"Pausar",PLAY:"Jugar",CONTINUE:"Continuar",NEW_GAME:"Nuevo juego",HELP_GAME:"?",GAME_MODAL_BTN_HEADER_CLOSE:"&#x2716;",GAME_MODAL_BTN_FOOTER_CLOSE:"Cerrar"};constructor(e){this.document=document.querySelector("body"),this.objCanvas=void 0,this.gameContainer=document.getElementById(e),this.canvas=this.createCanvas(),this.gameHelpModal=this.createGameHelpModal(),this.controlsGame=this.createControlsGame(),this.gameContainer.classList.add(PixelWar.CLASS_LIST.GAME_CONTAINER),this.gameContainer.appendChild(this.canvas),this.gameContainer.appendChild(this.controlsGame),this.document.appendChild(this.gameHelpModal.el)}createCanvas(){var e=document.createElement("div");return e.classList.add(PixelWar.CLASS_LIST.CANVAS),e.setAttribute("id",PixelWar.CANVAS_ID),e}createControlsGame(){var e=document.createElement("div"),t=this.createContainerCanvasSize(),s=this.createCbxDifficultGame(),a=this.createBtnStartGame(s,t),i=this.createBtnPauseGame(),r=this.createBtnNewGame(i),n=this.createBtnHelp();return e.classList.add(PixelWar.CLASS_LIST.CONTROLS),e.appendChild(t.el),e.appendChild(s),e.appendChild(a),e.appendChild(i),e.appendChild(r),e.appendChild(n),e}createContainerCanvasSize(){var e=document.createElement("div"),t=document.createElement("select"),s=document.createElement("select");return this.addOptionsToCbxByRange(t,PixelWar.LIMIT_TOTAL_COLUMNS,"Columnas ",PixelWar.TOTAL_COLUMNS_DEFAULT_VALUE),this.addOptionsToCbxByRange(s,PixelWar.LIMIT_TOTAL_ROWS,"Filas ",PixelWar.TOTAL_ROWS_DEFAULT_VALUE),e.classList.add(PixelWar.CLASS_LIST.CBXS_CANVAS_SIZE),e.appendChild(t),e.appendChild(s),{el:e,cbxTotalCols:t,cbxTotalRows:s}}addOptionsToCbxByRange(t,s,a=null,i=1){for(let e=s.min;e<=s.max;++e){var r=document.createElement("option");r.setAttribute("value",e),r.textContent=""+a+e,e===i&&r.setAttribute("selected","true"),t.appendChild(r)}}createCbxDifficultGame(){var e=document.createElement("select");return e.classList.add(PixelWar.CLASS_LIST.CBX_DIFFICULT_GAME),e.innerHTML=`
            <option value="${PixelWar.DIFFICULT.EASY}">Fácil</option>
            <option value="${PixelWar.DIFFICULT.NORMAL}">Normal</option>
            <option value="${PixelWar.DIFFICULT.HARD}">Difícil</option>
        `,e}createBtnStartGame(s,{cbxTotalCols:a,cbxTotalRows:i}){var e=document.createElement("button");return e.classList.add(PixelWar.CLASS_LIST.BTN_START_GAME),e.setAttribute("type","button"),e.textContent=PixelWar.TEXT_CONENT_LIST.PLAY,e.addEventListener("click",()=>{var e=a.value*PixelWar.CELL_SIZE.width,t=i.value*PixelWar.CELL_SIZE.height;canvas.setAttribute("style",`width: ${e}rem; height: ${t}rem`),void 0===this.objCanvas?this.objCanvas=new Canvas(PixelWar.CANVAS_ID,parseInt(a.value),parseInt(i.value),s.value):(this.objCanvas.nbrColumns=parseInt(a.value),this.objCanvas.nbrRows=parseInt(i.value),this.objCanvas.difficult=s.value),this.objCanvas.startNewGame(),this.gameContainer.classList.add(PixelWar.CLASS_LIST.PLAYING)}),e}createBtnPauseGame(){const e=document.createElement("button");return e.classList.add(PixelWar.CLASS_LIST.BTN_PAUSE_GAME),e.setAttribute("type","button"),e.textContent=PixelWar.TEXT_CONENT_LIST.PAUSE,e.addEventListener("click",()=>{if(this.objCanvas.gameOver)return!1;this.objCanvas.pause?(e.textContent=PixelWar.TEXT_CONENT_LIST.PAUSE,this.objCanvas.startGame()):(e.textContent=PixelWar.TEXT_CONENT_LIST.CONTINUE,this.objCanvas.pauseGame())}),e}createBtnNewGame(e){var t=document.createElement("button");return t.classList.add(PixelWar.CLASS_LIST.BTN_NEW_GAME),t.setAttribute("type","button"),t.textContent=PixelWar.TEXT_CONENT_LIST.NEW_GAME,t.addEventListener("click",()=>{this.objCanvas.gameOver=!0,this.objCanvas.startGame(),this.gameContainer.classList.remove(PixelWar.CLASS_LIST.PLAYING),e.textContent=PixelWar.TEXT_CONENT_LIST.PAUSE}),t}createBtnHelp(){var e=document.createElement("button");return e.classList.add(PixelWar.CLASS_LIST.BTN_HELP_GAME),e.textContent=PixelWar.TEXT_CONENT_LIST.HELP_GAME,e.addEventListener("click",()=>this.gameHelpModal.open()),e}createGameHelpModal(){var e={open:()=>this.objCanvas?.pauseGame(),close:()=>this.objCanvas?.startGame()},e=this.createGameModal(PixelWar.CLASS_LIST.GAME_MODAL_SIZE_MEDIUM,"AYUDA DEL JUEGO",e);return e.body.innerHTML=`
            <strong>Movimiento</strong>
            <ul>
                <li>
                    <strong>Izquierda:</strong> A
                </li>
                <li>
                    <strong>Derecha:</strong> D
                </li>
            </ul>

            <br>

            <strong>Ataque</strong>
            <ul>
                <li>
                    <strong>Disparo normal:</strong> J
                </li>
                <li>
                    <strong>Super disparo:</strong> K<br>
                    <span style="font-size: .75rem;">
                        Varias veces más destructivo que un disparo normal.
                    </span>
                </li>
                <li>
                    <strong>Crear portal:</strong> H<br>
                    <span style="font-size: .75rem;">
                        El portal traga a tus enemigos pero tiene un límite,
                        varios disparos al mismo lugar aumenta la fuerza del portal.
                    </span>
                </li>
                <li>
                    <strong>Ralentizar el tiempo:</strong> N<br>
                    <span style="font-size: .75rem;">
                        Aumenta el tiempo que le toma a tus enemigos moverse y aparecer.
                        Usarlo varias veces aumenta el tiempo del efecto.
                    </span>
                </li>
            </ul>
        `,e}createGameModal(e,t="",s=null){const a=document.createElement("div");var i=document.createElement("div"),r=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div"),l=document.createElement("button"),h=document.createElement("button");const c={el:a,header:r,body:n,footer:o,open(){a.classList.remove(PixelWar.CLASS_LIST.GAME_MODAL_HIDDEN),s?.open()},close(){a.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_HIDDEN),s?.close()}};return l.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_BTN_CLOSE),l.addEventListener("click",()=>c.close()),l.innerHTML=PixelWar.TEXT_CONENT_LIST.GAME_MODAL_BTN_HEADER_CLOSE,h.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_BTN_CLOSE),h.addEventListener("click",()=>c.close()),h.innerHTML=PixelWar.TEXT_CONENT_LIST.GAME_MODAL_BTN_FOOTER_CLOSE,r.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_HEADER),r.innerHTML=t,r.appendChild(l),n.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_BODY),o.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_FOOTER),o.appendChild(h),i.classList.add(PixelWar.CLASS_LIST.GAME_MODAL_CONTAINER),i.appendChild(r),i.appendChild(n),i.appendChild(o),a.classList.add(PixelWar.CLASS_LIST.GAME_MODAL,e),a.appendChild(i),c}}new PixelWar("game");